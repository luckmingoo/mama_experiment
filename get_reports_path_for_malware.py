#! /usr/bin/env python
# -*- coding: utf-8 -*-

'''
Created on 2019-12-20

@author: mingo
@module: experiment_mama.get_reports_path_for_malware
'''

import csv 
import os 

def get_amd_dataset_report_path():
    dataset_report_path_dict = {}
    amd_dataset_csv = '/mnt/AMD/malware_dataset_amd.csv'
    with open(amd_dataset_csv, 'r') as f:
        reader = csv.reader(f) 
        for row in reader:
            md5 = row[0]
            report_path = '/mnt/AMD/amd_reports/{}.json'.format(md5)
            dataset_report_path_dict[md5] = report_path
    return dataset_report_path_dict

def get_virustotal_dataset_report_path():
    dataset_report_path_dict = {}
    md5_sha256_mapping = {}
    with open('/mnt/VirusTotal/VirusTotal_apks_info.csv', 'r') as f:
        reader = csv.reader(f) 
        for row in reader:
            sha256 = row[0]
            md5 = row[1]
            md5_sha256_mapping[md5] = sha256
    virustotal_dataset_csv = '/mnt/VirusTotal/malware_dataset_virustotal.csv'
    with open(virustotal_dataset_csv, 'r') as f:
        reader = csv.reader(f) 
        for row in reader:
            md5 = row[0]
            if md5 in md5_sha256_mapping:
                sha256 = md5_sha256_mapping[md5]
                report_path = '/mnt/VirusTotal/Reports/{}.json'.format(sha256)
                dataset_report_path_dict[md5] = report_path
    return dataset_report_path_dict 

def get_virusshare_dataset_report_path():
    dataset_report_path_dict = {}
    virusshare_dataset_csv = '/mnt/VirusShare/malware_dataset_virusshare.csv'
    with open(virusshare_dataset_csv, 'r') as f:
        reader = csv.reader(f) 
        for row in reader:
            md5 = row[0]
            report_path = '/mnt/tmp_VirusShare/VirusShare_Android_reports/{}.json'.format(md5)
            dataset_report_path_dict[md5] = report_path
    return dataset_report_path_dict

def get_reports_path_for_malware():
    amd_reports_path = get_amd_dataset_report_path()
    virustotal_reports_path = get_virustotal_dataset_report_path()
    virusshare_reports_path = get_virusshare_dataset_report_path()
    malware_dataset_reports_path = []
    malware_dataset_csv = '/mnt/VirusShare/malware_dataset_vs_vt_amd.csv' 
    with open(malware_dataset_csv, 'r') as f:
        reader = csv.reader(f)
        for row in reader:
            md5 = row[0]
            first_seen = row[1]
            vt_cnt = int(row[2])
            if md5 in amd_reports_path:
                report_path = amd_reports_path[md5]
            elif md5 in virustotal_reports_path:
                report_path = virustotal_reports_path[md5]
            elif md5 in virusshare_reports_path:
                report_path = virusshare_reports_path[md5]
            else:
                print('error in find %s report path' % (md5))
            malware_dataset_reports_path.append([md5, first_seen, vt_cnt, report_path])
    with open('malware_dataset_reports_path.csv', 'wb') as f:
        writer = csv.writer(f) 
        writer.writerows(malware_dataset_reports_path)
    print('finish')

if __name__ == "__main__":
    get_reports_path_for_malware()
    